
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title></title>
  <meta name="description" content="">

  <link rel="canonical" href="">
  <link rel="alternate" type="application/rss+xml" title="" href="" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
  <style>
  @import url('https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300i,400,400i,600,700');
  </style>

  <style>

  html, body {
  	width: 100%;
  	height: 100%;
  }

  #map {
	width: 100%;
	height: 100%;
  }

  .popup {
    font-family: 'Source Sans Pro';
    max-height: 200px;
    overflow-y: auto;
  }
  .popup > a {
    text-decoration:none;
    font-weight:600;
    color: #000244;
  }
  
  .sm-circle {
    background-color: #00549f;
    border-radius: 50%;
    text-align: center;
    font-size: 10px;
    font-family: 'Source Sans Pro';
    opacity: 0.85;
    border: 1px solid #ffffff;
  }
  .med-circle {
    line-height: 20px;
    background-color: #00549f;
    border-radius: 50%;
    text-align: center;
    font-size: 10px;
    font-family: 'Source Sans Pro';
    opacity: 0.85;
    border: 1px solid #ffffff;
    color:#fcfcfc;
  }
  .big-circle {
    line-height: 30px;
    background-color: #00549f;
    border-radius: 50%;
    text-align: center;
    font-size: 10px;
    font-family: 'Source Sans Pro';
    opacity: 0.85;
    border: 1px solid #ffffff;
    color:#fcfcfc;
  }

</style>

</head>

<body>

<div id="map"></div>

<!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>-->
<script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
<script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>

<script>
  window.onload = function(){
    drawMap();
  }

function drawMap(){
      
      var map = L.map("map",{zoomControl:false}).setView([32.7099168, -117.1841209]);
      map.setZoom(13);
      map.addControl(L.control.zoom({position:'topright'}));
      L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
      {
          attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
      }).addTo(map);
      var u = 'https://cityofsandiego-admin.carto.com/api/v2/sql?q=SELECT * FROM andrellbower.public_art_locations_datasd&api_key=0e5603ded008d02e844d5888e07e8f36e195fd93';
    function getGeom(callback){
      $.ajax({
        url: u,
        success: function(response){
          callback(response);
        }
      })
    }
    getGeom(function(data){
      
      artWork = createArt(data);
      var length = artWork.length;
      for (i=0;i<length;i++) {
        var facility = artWork[i].location;
        var noPieces = artWork[i].artwork.length;
        var geom = artWork[i].latlng;

        if (noPieces === 1) {
          var iconOptions = {iconSize:[10,10],html:'',className:'sm-circle'};
          var popupContent = '<div class="popup"><p><b>'+facility+'</b></p>';
          popupContent += '<p><i>'+artWork[i].artwork[0].name+'</i><br>'+artWork[i].artwork[0].artist+'</p></div>';
        } else {
          if (noPieces <= 10) {
            var iconOptions = {iconSize:[20,20],html:noPieces,className:'med-circle'};
          } else {
            var iconOptions = {iconSize:[30,30],html:noPieces,className:'big-circle'};
          }
          var popupContent = '<div class="popup"><p><b>'+facility+'</b></p>';
          for (j=0;j<noPieces;j++) {
            popupContent += '<p><i>'+artWork[i].artwork[j].name+'</i><br>'+artWork[i].artwork[j].artist;
            if (artWork[i].artwork[j].add_location) {
              popupContent += '<br>'+artWork[i].artwork[j].add_location+'</p>';
            } else {
              popupContent += '</p>';
            }
            
          }
          popupContent += '</div>';

        }

        
        var noIcon = L.divIcon(iconOptions);
        var circle = L.marker();
        circle.setLatLng(geom);
        circle.setIcon(noIcon);
          /*
          circle.setStyle({
            stroke: true,
            color: "#80e0d3",
            weight: 0.3,
            fillOpacity: 0.75,
            fillColor: "#80e0d3",
            className: "art"
          });
          */
        circle.bindPopup(popupContent).openPopup();
        circle.addTo(map);
          //map.addLayer(circle);
      }

  	});
  	
 }

 function createArt(data) {
  var results = data.total_rows;
  var coordsUnique = [];
  var art = [];
  if (results > 0){
    for (i=0;i<results;i++){
      var latlng = L.latLng(data.rows[i].latitude,data.rows[i].longitude);
      var latStr = String(data.rows[i].latitude);
      var lngStr = String(data.rows[i].longitude);
      var latlngStr = latStr+","+lngStr;
      var coordsCheck = arrayContains(latlngStr,coordsUnique);
      var name = data.rows[i].artwork_title;
      var artist = data.rows[i].artist;
      var facility = data.rows[i].location;
      
      var appt = data.rows[i].status;
      if (appt === 'Collection Status : By Appointment Only / Contact the Hervey Family Rare Book Room' | 
        appt === 'Collection Status : Public Tours Available / Contact the Commission for Arts and Culture') {
      	var apptDisplay = "Yes";
      } else {
      	var apptDisplay = "No"
      }

      var facility_parts = facility.split(':');
      var facility_name = facility_parts[2].trim();
      if (facility_parts.length > 3) {
        var loc_details = "";
        var address = facility_parts[3];
        if (address.includes(",")) {
          var address_parts = address.split(",");
          var floor = address_parts[1].trim();
          loc_details += floor;
        } else {
          for (d=4;d<facility_parts.length;d++){
            if (loc_details === "") {
              loc_details+=facility_parts[d].trim();
            } else {
              loc_details+=", "+facility_parts[d].trim();
            }
            
          }
        }
      }
		
	  
      if (coordsCheck === -1) {
      	coordsUnique.push(latlngStr);
      	art.push({location:facility_name,latlng:latlng,artwork:[{name:name, artist:artist, appt:apptDisplay}]});
      } else {
      	art[coordsCheck].artwork.push({name:name, artist:artist, appt:apptDisplay, add_location:loc_details});
      }



  	}
  	
    return art;

	}
 }

 function arrayContains(n, array) {
 	return (array.indexOf(n));
 }



</script>


  </body>

</html>

{{ define "main" }}


{{- $urlviewcounts := $.Site.Params.dsViewsCsv }}
{{- with resources.GetRemote $urlviewcounts }}
  {{- with .Err }}
    {{- errorf "%s" . }}
  {{- else }}
    {{- $.Scratch.Add "dsViewCounts" ( . | transform.Unmarshal ) }}
  {{- end }}
{{- else }}
  {{- errorf "Unable to get remote resource %q" $urlviewcounts }}
{{- end }}


{{- $urlrowcounts :=  $.Site.Params.rowNosCsv }}
{{- with resources.GetRemote $urlrowcounts }}
  {{- with .Err }}
    {{- errorf "%s" . }}
  {{- else }}
    {{- $.Scratch.Add "distroRowCounts" ( . | transform.Unmarshal ) }}
  {{- end }}
{{- else }}
  {{- errorf "Unable to get remote resource %q" $urlrowcounts }}
{{- end }}


{{- $thisIdentifier := (path.Base .RelPermalink) }}
{{- $pageCatList := $.Params.categories }}
{{- $selectedPageCat := index $pageCatList 0 }}
{{- $thisViewCount := 0 }}

{{- range $i, $e := $.Scratch.Get "dsViewCounts" }}
{{- $currViewsRow := index $e 0 }}
{{- if eq $currViewsRow $thisIdentifier }}
{{- $thisViewCount = int (index $e 1) }}
{{- end }}
{{- end }}

<div class="container">
	<div class="row">
		<div class="col pt-5">
			<div class="mb-4">
				{{ range .Params.departments }}
				<a class="btn btn-sm me-2 dataset-taxonomy-btn fst-italic fw-normal" href="/departments/{{ . | urlize }}" role="button">{{ . }}</a>
				{{ end }}
				{{ range .Params.categories }}
				<a class="btn btn-sm me-2 dataset-taxonomy-btn fst-italic fw-normal" href="/categories/{{ . | urlize }}" role="button">{{ . }}</a>
				{{ end }}
			</div>
			<h1 class="display-4 mb-5">
				{{ .Title }}
			</h1>
			<p class="mb-3"><span class="dataset-metadata-label fw-bold">Last updated:</span> </p>
			<div class="dataset-text fs-5 mb-5">
				{{ .Summary }}
			</div>
		</div>
	</div>
	<div class="row pb-7">
		<div class="col-4">
			{{- range first 1 .Params.distributions -}} <!-- loop to get downloads -->
			{{ partial "download-card" (dict "distribution" . "dlCardCat" (anchorize $selectedPageCat) "dlRows" ($.Scratch.Get "distroRowCounts") ) }}
			{{- end -}}
		</div>
		<div class="col-8">
			<div class="dataset-metadata mb-5">
				<p><span class="dataset-metadata-label fw-bold">Temporal:</span> {{ .Params.temporal }} {{ partial "temporal-definition" . }}</p>
				<p><span class="dataset-metadata-label fw-bold">Spatial:</span> {{ .Params.spatial }} {{ partial "spatial-definition" . }}</p>
				<p><span class="dataset-metadata-label fw-bold">Views:</span> {{ $thisViewCount | lang.FormatNumber 0 }}</p>
				<p><span class="dataset-metadata-label fw-bold">Issued:</span> {{ .Params.date_issued }}</p>
			</div>
			<div class="dataset-jump-links mb-5">
				<span class="me-4 d-inline fst-italic">Jump to: </span>
				<a class="me-4" href="#dataDictionary">Data dictionary</a>
				<a class="me-4" href="#dataFilters">Filter the data</a>
				<a class="me-4" href="#">Insights</a>
				{{ with .Content }}<a class="me-4" href="#addDetails">Additional details</a>{{ end }}
			</div>
			<div class="p-3 mb-2 dataset-tags d-flex align-items-center">
				<span class="me-4 d-inline">Tags: </span>
				{{ range .Params.tags }}
				<a class="tag me-4" href="/tags/{{ . | urlize }}">{{ . }}</a>
				{{ end }}
			</div>
		</div>
	</div>
</div>
{{- $noDistros := .Params.distributions | len }}
{{- $remNoDistros := sub $noDistros 1 }}
{{- if gt $remNoDistros 0 }}
{{- $remDistros := last $remNoDistros  .Params.distributions }}
{{- $filterGroups := slice }}
{{- range $remDistros }}
{{- range .filterGroup }}
{{- $filterGroups = $filterGroups | append . }}
{{- end }}
{{- end }}
{{- $uniqueFilterGroups := $filterGroups | uniq }}
<div class="container-fluid pb-7">
    <div class="container">
		<div class="row">
			<div class="col">
				<h1 class="display-6 mb-5" id="dataFilters">
					More Downloads
				</h1>
			</div>
		</div>
        <div class="row">
			<div class="col">
				<ul class="nav nav-pills more-downloads-nav fs-5 fw-bold mb-5" id="moreDownloadsTab" role="tablist">
					{{- range $i, $e := $uniqueFilterGroups }}
					<li class="nav-item me-5" role="presentation">
					<button class="nav-link {{ if eq 0 $i }}active{{ end }}" id="{{ $e }}-tab" data-bs-toggle="tab" data-bs-target="#{{ $e }}-tab-pane" type="button" role="tab" aria-controls="{{ $e }}-tab-pane" aria-selected={{ if eq 0 $i }}"true"{{ else }}"false"{{ end }}>Filtered by {{ $e }}</button>
					</li>
					{{- end }}
				</ul>
				<div class="tab-content" id="moreDownloadsTabContent">
					{{- range $i, $e := $uniqueFilterGroups }}
					<div class="tab-pane fade {{ if eq 0 $i }}show active{{ end }}" id="{{ $e }}-tab-pane" role="tabpanel" aria-labelledby="{{ $e }}-tab" tabindex="{{ $i }}">
						<div class="more-downloads-table">
							<table class="table" id="accordionColumnsDownloads">
								<tbody>
									{{/* This block gets the list of distributions in the filter group */}}
									{{- $remDistrosThisFilter := slice }}
									{{- range  sort $remDistros "weight" "desc" }}
									{{- $thisRemDistro := . }}
									{{- range .filterGroup }}
									{{- if eq . $e }}
									{{- $remDistrosThisFilter = $remDistrosThisFilter | append $thisRemDistro }}
									{{- end }}
									{{- end }}
									{{- end }}
									{{/* Now we range through the distributions in the filter group to make the table */}}
									{{- range $i, $r := $remDistrosThisFilter }}
									{{/* 
										We need the view counts. 
										This code block is repeated in download-card partial
									*/}}
									{{- $thisURL := printf "%s" .url }}
									{{- $thisRowCount := 0 }}
									{{- range $i, $e := $.Scratch.Get "distroRowCounts" }}
									{{- $currDlRow := index $e 0 }}
									{{- if eq $currDlRow $thisURL }}
									{{- $thisRowCount = int (index $e 1) }}
									{{- end }}
									{{- end }}
									<tr class="fs-5 fw-semibold">
										<td class="align-middle">{{ .name }}</td>
										<td class="align-middle">
											<a href="{{ .url }}" class="btn btn-sm btn-outline-{{ (anchorize $selectedPageCat) }}">Download</a>
										</td>
										<td><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDl{{ $i }}" aria-expanded="true" aria-controls="collapseDl{{ $i }}"></button></td>
									</tr>
									<tr id="collapseDl{{ $i }}" class="fs-6 accordion-body collapse">
										<td class="accordion-body" colspan="3">
											<p>Format: <span class="fw-bold">{{ .format }}</span></p>
											<p>File size: <span class="fw-bold">000 MB</span></p>
											<p>No. rows: <span class="fw-bold">{{ $thisRowCount | lang.FormatNumber 0 }}</span> {{ if gt $thisRowCount $.Site.Params.excelLimit }}{{ partial "excel-warning" . }}{{- end }}</p>
											<p>{{ .filter }}</p>
										</td>
									</tr>
									{{- end }}
								</tbody>
							</table>
						</div>
					</div>
					{{- end }}
				</div>
			</div>
        </div>
    </div>
</div>
{{- else }} 
{{- end }}
<div class="container-fluid dataset-dictionary-contain py-7">
	<div class="container">
		<div class="row">
			<div class="col">
				<div>
					<h1 class="display-4" id="dataDictionary">
						Data Dictionary
					</h1>
				</div>
			</div>
		</div>
		{{ partial "data-dictionary" . }} 
	</div>
</div>
{{ with .Content }}
<div class="container py-7">
	<div class="row">
		<div class="col">
			<div>
				<h1 class="display-4" id="addDetails">
					Additional details
				</h1>
			</div>
		</div>
	</div>
	<div class="row mt-4">
		{{ . }}
	</div>
</div>
{{ end }}
{{ partial "datasets-categories-lg" . }}
{{ end }}